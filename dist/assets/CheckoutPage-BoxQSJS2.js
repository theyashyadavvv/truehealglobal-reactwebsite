import{d as te,l as ne,n as oe,o as ie,p as re,r as o,q as de,j as e,m as le,S as m,s as ue,G as B,t as he,w as F,x as M,y as U,z as me,A as pe,B as _e,C as xe,D as G,E as je,F as ye}from"./index-BL3vTOoB.js";import{a as ke}from"./coupons-BuziIPNb.js";function Ce(){const p=te(),{user:i,isLoggedIn:I,token:ge}=ne(),{items:r,subtotal:C,clearCart:Y}=oe(),h=ie(),{toggles:d,config:ve}=re(),[$,J]=o.useState([]),[c,P]=o.useState(null),[k,W]=o.useState("cash_on_delivery"),[g,D]=o.useState(""),[_,E]=o.useState(0),[H,S]=o.useState(""),[x,q]=o.useState(!1),[z,K]=o.useState(""),[b,Q]=o.useState("0"),[T,L]=o.useState(!1),[V,X]=o.useState(!0),[R,j]=o.useState(""),v=[];(d==null?void 0:d.cashOnDelivery)!==!1&&v.push({id:"cash_on_delivery",label:"Cash on Delivery",icon:U}),(d==null?void 0:d.digitalPayment)!==!1&&v.push({id:"digital_payment",label:"Online Payment",icon:M}),(d==null?void 0:d.wallet)!==!1&&v.push({id:"wallet",label:"Wallet",icon:xe});const Z=["0","10","20","50","100"];o.useEffect(()=>{if(!I){p("/login");return}if(r.length===0){p("/cart");return}ee()},[I,r.length]);const ee=async()=>{try{const s=await de(),t=(s==null?void 0:s.addresses)||(s==null?void 0:s.data)||(Array.isArray(s)?s:[]);J(t),t.length>0&&P(t[0])}catch(s){console.error(s)}finally{X(!1)}},se=async()=>{var s,t,y;if(g.trim()){S("");try{const u=((t=(s=r[0])==null?void 0:s.item)==null?void 0:t.store_id)||((y=r[0])==null?void 0:y.store_id)||"",n=await ke(g,u);n.discount?(E(n.discount),q(!0),h.success(`Coupon applied! You save ₹${n.discount}`)):S(n.message||"Invalid coupon")}catch(u){S(u.message||"Coupon failed")}}},w=C>5e4?0:499,A=parseFloat(b)||0,O=C-_+w+A,ae=async()=>{var s,t,y;if(!c){j("Please select a delivery address"),h.warning("Please select a delivery address");return}j(""),L(!0);try{const u={cart:JSON.stringify(r.map(a=>({item_id:a.item_id||a.id,cart_id:a.cart_id||a.id,item_campaign_id:a.item_campaign_id||null,price:String(a.price||0),variant:a.variant||"",variation:a.variation||[],quantity:a.quantity||1,add_on_ids:a.add_on_ids||[],add_on_qtys:a.add_on_qtys||[],model:"Item"}))),order_amount:String(O),payment_method:k,order_type:"delivery",store_id:String(((t=(s=r[0])==null?void 0:s.item)==null?void 0:t.store_id)||((y=r[0])==null?void 0:y.store_id)||""),store_ids:[...new Set(r.map(a=>{var f;return((f=a.item)==null?void 0:f.store_id)||a.store_id}).filter(Boolean))].map(String),coupon_code:x?g:"",coupon_discount_amount:String(_),coupon_discount_title:x?"Coupon":"",discount_amount:"0",tax_amount:"0",distance:"0",schedule_at:"",order_note:z,dm_tips:b,address:c.address||"",latitude:String(c.latitude||""),longitude:String(c.longitude||""),contact_person_name:c.contact_person_name||(i==null?void 0:i.f_name)||"",contact_person_number:c.contact_person_number||(i==null?void 0:i.phone)||"",contact_person_email:(i==null?void 0:i.email)||"",address_type:c.address_type||"other",road:c.road||"",house:c.house||"",floor:c.floor||"",delivery_address_id:String(c.id),partial_payment:"0",is_buy_now:"0",guest_id:G()||""},n=await je(u),N=n.order_id||n.id;if(N){if(k==="digital_payment"){const a=(i==null?void 0:i.id)||G(),f=`${window.location.origin}/order-success?id=${N}&status=`,ce=`${ye}/payment-mobile?order_id=${N}&customer_id=${a}&payment_method=stripe&payment_platform=web&callback=${encodeURIComponent(f)}`;h.info("Redirecting to payment gateway..."),window.location.href=ce;return}await Y(),h.success("Order placed successfully!"),p(`/order-success?id=${N}`)}else if(n.errors){const a=typeof n.errors=="object"?Object.values(n.errors).flat().join(". "):String(n.errors);j(a),h.error(a)}else j(n.message||"Order placement failed"),h.error(n.message||"Order placement failed")}catch(u){j(u.message||"Something went wrong"),h.error(u.message||"Something went wrong")}finally{L(!1)}},l=s=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(s||0);return e.jsxs("main",{className:"checkout-page",children:[e.jsx("section",{className:"checkout-page__hero",children:e.jsx("div",{className:"container",children:e.jsxs(le.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx("h1",{className:"checkout-page__title",children:"Checkout"}),e.jsxs("p",{className:"checkout-page__subtitle",children:[r.length," item",r.length!==1?"s":""," in order"]})]})})}),e.jsx("section",{className:"checkout-page__content section",children:e.jsx("div",{className:"container",children:e.jsxs("div",{className:"checkout-layout",children:[e.jsxs("div",{className:"checkout-main",children:[e.jsx(m,{children:e.jsxs("div",{className:"checkout-section",children:[e.jsxs("h3",{className:"checkout-section__title",children:[e.jsx(ue,{})," Delivery Address"]}),V?e.jsx("div",{className:"checkout-skeleton"}):$.length===0?e.jsxs("div",{className:"checkout-empty-address",children:[e.jsx("p",{children:"No saved addresses found"}),e.jsxs(B,{size:"sm",onClick:()=>p("/addresses"),children:[e.jsx(he,{size:16})," Add Address"]})]}):e.jsx("div",{className:"checkout-addresses",children:$.map(s=>e.jsxs("div",{className:`checkout-address-card ${(c==null?void 0:c.id)===s.id?"selected":""}`,onClick:()=>P(s),children:[e.jsx("div",{className:"checkout-address-card__check",children:(c==null?void 0:c.id)===s.id&&e.jsx(F,{size:16})}),e.jsxs("div",{className:"checkout-address-card__content",children:[e.jsx("span",{className:"checkout-address-card__type",children:s.address_type||"Other"}),e.jsx("p",{className:"checkout-address-card__text",children:s.address}),e.jsxs("p",{className:"checkout-address-card__contact",children:[s.contact_person_name," - ",s.contact_person_number]})]})]},s.id))})]})}),e.jsx(m,{delay:.1,children:e.jsxs("div",{className:"checkout-section",children:[e.jsxs("h3",{className:"checkout-section__title",children:[e.jsx(M,{})," Payment Method"]}),e.jsx("div",{className:"checkout-payment-methods",children:v.map(s=>e.jsxs("div",{className:`checkout-payment-card ${k===s.id?"selected":""}`,onClick:()=>W(s.id),children:[e.jsx(s.icon,{size:22}),e.jsx("span",{children:s.label}),k===s.id&&e.jsx(F,{size:16})]},s.id))})]})}),e.jsx(m,{delay:.12,children:e.jsxs("div",{className:"checkout-section",children:[e.jsxs("h3",{className:"checkout-section__title",children:[e.jsx(U,{})," Delivery Tip"]}),e.jsx("div",{className:"checkout-tips",children:Z.map(s=>e.jsx("button",{className:`checkout-tip-btn ${b===s?"selected":""}`,onClick:()=>Q(s),children:s==="0"?"No Tip":`₹${s}`},s))})]})}),e.jsx(m,{delay:.15,children:e.jsxs("div",{className:"checkout-section",children:[e.jsxs("h3",{className:"checkout-section__title",children:[e.jsx(me,{})," Apply Coupon"]}),e.jsxs("div",{className:"checkout-coupon",children:[e.jsx("input",{type:"text",placeholder:"Enter coupon code",value:g,onChange:s=>D(s.target.value),disabled:x}),x?e.jsx("button",{className:"coupon-remove-btn",onClick:()=>{q(!1),E(0),D("")},children:"Remove"}):e.jsx("button",{className:"coupon-apply-btn",onClick:se,children:"Apply"})]}),H&&e.jsx("p",{className:"checkout-coupon-error",children:H}),x&&e.jsxs("p",{className:"checkout-coupon-success",children:["Coupon applied! You save ",l(_)]})]})}),e.jsx(m,{delay:.2,children:e.jsxs("div",{className:"checkout-section",children:[e.jsxs("h3",{className:"checkout-section__title",children:[e.jsx(pe,{})," Order Note"]}),e.jsx("textarea",{className:"checkout-note",rows:3,placeholder:"Any special instructions...",value:z,onChange:s=>K(s.target.value)})]})})]}),e.jsx(m,{direction:"left",children:e.jsxs("div",{className:"checkout-summary",children:[e.jsx("h3",{className:"checkout-summary__title",children:"Order Summary"}),e.jsx("div",{className:"checkout-summary__items",children:r.map(s=>e.jsxs("div",{className:"checkout-summary__item",children:[e.jsx("img",{src:s.image_full_url||s.image||"/assets/image/placeholder.jpg",alt:s.name,onError:t=>{console.log("Image failed:",t.target.src),t.target.onerror=null,t.target.src="/assets/image/placeholder.jpg"}}),e.jsxs("div",{children:[e.jsx("p",{className:"item-name",children:s.name}),e.jsxs("p",{className:"item-qty",children:["x",s.quantity||1]})]}),e.jsx("span",{children:l((s.price||0)*(s.quantity||1))})]},s.id))}),e.jsx("div",{className:"checkout-summary__divider"}),e.jsxs("div",{className:"checkout-summary__row",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:l(C)})]}),_>0&&e.jsxs("div",{className:"checkout-summary__row checkout-summary__row--discount",children:[e.jsx("span",{children:"Coupon Discount"}),e.jsxs("span",{children:["-",l(_)]})]}),e.jsxs("div",{className:"checkout-summary__row",children:[e.jsx("span",{children:"Shipping"}),e.jsx("span",{children:w===0?"Free":l(w)})]}),A>0&&e.jsxs("div",{className:"checkout-summary__row",children:[e.jsx("span",{children:"Delivery Tip"}),e.jsx("span",{children:l(A)})]}),e.jsx("div",{className:"checkout-summary__divider"}),e.jsxs("div",{className:"checkout-summary__row checkout-summary__row--total",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:l(O)})]}),R&&e.jsx("div",{className:"checkout-error",children:R}),e.jsx(B,{size:"lg",block:!0,onClick:ae,disabled:T,children:T?"Placing Order...":`Place Order - ${l(O)}`}),e.jsxs("button",{className:"checkout-back-btn",onClick:()=>p("/cart"),children:[e.jsx(_e,{size:16})," Back to Cart"]})]})})]})})})]})}export{Ce as default};
